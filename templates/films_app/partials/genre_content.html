{% load films_tags %}

{% if selected_genre %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                    <h4 class="mb-0">{{ selected_genre }} Films</h4>
                    <span class="badge bg-light text-dark">
                        {% display_period period %}
                    </span>
                </div>
                <div class="card-body">
                    <div id="genre-chart-container" style="height: 300px;"></div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="row mb-4">
        <div class="col-12">
            <h2 class="border-bottom pb-2">
                Top {{ selected_genre }} Films
                <small class="text-muted">{{ films|length }} film{{ films|length|pluralize }}</small>
            </h2>
        </div>
    </div>
    
    <div class="row">
        {% if films %}
            {% for film in films %}
                <div class="col-md-3 mb-4">
                    <div class="card film-card">
                        <div class="vote-badge">{{ film.vote_count }} vote{{ film.vote_count|pluralize }}</div>
                        <img src="{{ film.poster_url|default:'https://via.placeholder.com/300x450?text=No+Poster' }}" 
                             class="card-img-top film-poster" alt="{{ film.title }}">
                        <div class="card-body">
                            <h5 class="card-title">{{ film.title }}</h5>
                            <p class="card-text text-muted">{{ film.year }}</p>
                            <p class="card-text">
                                <small class="text-muted">
                                    <strong>Genres:</strong> {{ film.genres }}
                                </small>
                            </p>
                            <a href="{% url 'films_app:film_detail' film.imdb_id %}" class="btn btn-sm btn-primary">View Details</a>
                        </div>
                    </div>
                </div>
            {% endfor %}
        {% else %}
            <div class="col-12">
                <div class="alert alert-info">
                    No films found in the {{ selected_genre }} genre for the selected time period. Try another genre or time period.
                </div>
            </div>
        {% endif %}
    </div>
{% else %}
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                    <h4 class="mb-0">Genre Distribution</h4>
                    <span class="badge bg-light text-dark">
                        {% display_period period %}
                    </span>
                </div>
                <div class="card-body">
                    <div id="genres-chart-container" style="height: 400px;"></div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="row mt-4">
        <div class="col-12">
            <div class="alert alert-info">
                <i class="fas fa-info-circle me-2"></i>
                Select a genre from the dropdown above to see films in that genre.
            </div>
        </div>
    </div>
{% endif %}

<script>
    // Check if Chart.js is loaded
    if (typeof Chart === 'undefined') {
        console.error('Chart.js is not loaded. Loading it now...');
        // Create a script element to load Chart.js
        var script = document.createElement('script');
        script.src = 'https://cdn.jsdelivr.net/npm/chart.js';
        script.onload = function() {
            console.log('Chart.js loaded successfully. Initializing charts...');
            initializeCharts();
        };
        script.onerror = function() {
            console.error('Failed to load Chart.js. Displaying fallback content.');
            if (document.getElementById('genre-chart-container')) {
                document.getElementById('genre-chart-container').innerHTML = 
                    '<div class="alert alert-warning">Unable to load chart library. Please refresh the page or try again later.</div>';
            }
            if (document.getElementById('genres-chart-container')) {
                document.getElementById('genres-chart-container').innerHTML = 
                    '<div class="alert alert-warning">Unable to load chart library. Please refresh the page or try again later.</div>';
            }
        };
        document.head.appendChild(script);
    } else {
        // Chart.js is already loaded, initialize charts
        initializeCharts();
    }

    function initializeCharts() {
        {% if selected_genre %}
            // Load genre-specific chart data
            $.ajax({
                url: '/api/charts/data/',
                data: { 
                    genre: '{{ selected_genre|escapejs }}',
                    period: '{{ period|escapejs }}'
                },
                success: function(response) {
                    if (response.labels && response.labels.length > 0) {
                        try {
                            const ctx = document.getElementById('genre-chart-container').getContext('2d');
                            new Chart(ctx, {
                                type: 'bar',
                                data: {
                                    labels: response.labels,
                                    datasets: [{
                                        label: 'Number of Votes',
                                        data: response.data,
                                        backgroundColor: 'rgba(13, 110, 253, 0.7)',
                                        borderColor: 'rgba(13, 110, 253, 1)',
                                        borderWidth: 1
                                    }]
                                },
                                options: {
                                    responsive: true,
                                    maintainAspectRatio: false,
                                    scales: {
                                        y: {
                                            beginAtZero: true,
                                            ticks: {
                                                precision: 0
                                            }
                                        }
                                    },
                                    plugins: {
                                        legend: {
                                            display: false
                                        },
                                        title: {
                                            display: true,
                                            text: 'Top {{ selected_genre|escapejs }} Films by Votes'
                                        }
                                    }
                                }
                            });
                        } catch (error) {
                            console.error('Error creating chart:', error);
                            $('#genre-chart-container').html('<div class="alert alert-danger">Error creating chart. Please try again later.</div>');
                        }
                    } else {
                        $('#genre-chart-container').html('<div class="alert alert-info">No data available for this genre and time period.</div>');
                    }
                },
                error: function(xhr, status, error) {
                    console.error('AJAX error:', status, error);
                    $('#genre-chart-container').html('<div class="alert alert-danger">Error loading chart data. Please try again later.</div>');
                }
            });
        {% else %}
            // Load overall genre distribution
            $.ajax({
                url: '/api/genres/data/',
                data: { period: '{{ period|escapejs }}' },
                success: function(response) {
                    if (response.labels && response.labels.length > 0) {
                        try {
                            const ctx = document.getElementById('genres-chart-container').getContext('2d');
                            new Chart(ctx, {
                                type: 'pie',
                                data: {
                                    labels: response.labels,
                                    datasets: [{
                                        data: response.data,
                                        backgroundColor: [
                                            'rgba(0, 123, 255, 0.7)',    // Blue (better contrast)
                                            'rgba(220, 53, 69, 0.7)',    // Red (better contrast)
                                            'rgba(255, 193, 7, 0.7)',    // Yellow
                                            'rgba(40, 167, 69, 0.7)',    // Green (better contrast)
                                            'rgba(111, 66, 193, 0.7)',   // Purple (better contrast)
                                            'rgba(253, 126, 20, 0.7)',   // Orange (better contrast)
                                            'rgba(23, 162, 184, 0.7)',   // Cyan (better contrast)
                                            'rgba(102, 16, 242, 0.7)',   // Indigo (better contrast)
                                            'rgba(32, 201, 151, 0.7)',   // Teal (better contrast)
                                            'rgba(52, 58, 64, 0.7)'      // Dark gray (better contrast)
                                        ],
                                        borderColor: [
                                            'rgba(0, 123, 255, 1)',
                                            'rgba(220, 53, 69, 1)',
                                            'rgba(255, 193, 7, 1)',
                                            'rgba(40, 167, 69, 1)',
                                            'rgba(111, 66, 193, 1)',
                                            'rgba(253, 126, 20, 1)',
                                            'rgba(23, 162, 184, 1)',
                                            'rgba(102, 16, 242, 1)',
                                            'rgba(32, 201, 151, 1)',
                                            'rgba(52, 58, 64, 1)'
                                        ],
                                        borderWidth: 1
                                    }]
                                },
                                options: {
                                    responsive: true,
                                    maintainAspectRatio: false,
                                    plugins: {
                                        legend: {
                                            position: 'right'
                                        },
                                        title: {
                                            display: true,
                                            text: 'Genre Distribution of Voted Films'
                                        },
                                        tooltip: {
                                            callbacks: {
                                                label: function(context) {
                                                    const label = context.label || '';
                                                    const value = context.raw || 0;
                                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                                    const percentage = Math.round((value / total) * 100);
                                                    return `${label}: ${value} films (${percentage}%)`;
                                                }
                                            }
                                        }
                                    }
                                }
                            });
                        } catch (error) {
                            console.error('Error creating chart:', error);
                            $('#genres-chart-container').html('<div class="alert alert-danger">Error creating chart. Please try again later.</div>');
                        }
                    } else {
                        $('#genres-chart-container').html('<div class="alert alert-info">No genre data available for this time period.</div>');
                    }
                },
                error: function(xhr, status, error) {
                    console.error('AJAX error:', status, error);
                    $('#genres-chart-container').html('<div class="alert alert-danger">Error loading chart data. Please try again later.</div>');
                }
            });
        {% endif %}
    }
</script> 